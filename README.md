# Paradex BTC 秒开关策略 v6 - 多号轮换版

纯 Python 后台 BTC 双向秒开秒关策略，使用 Paradex Interactive Token 免费交易，支持多账号自动轮换。

## 功能特点

- **WebSocket 实时价格**: 订阅 BBO 推送，延迟约 10-50ms
- **双向智能开仓**: 根据买一/卖一深度自动决定做多或做空方向
- **智能多账号轮换**: 支持配置多个账号，自动检查成交量并智能切换
- **成交量保障**: 每个账号未达到最小成交量会自动切回继续刷
- **最后一号保护**: 只剩最后一个号触发切号条件时暂停5分钟后继续
- **免手续费**: 使用 Interactive Token，0% maker/taker 费用
- **三级速率限制**: 26单/分钟、500单/小时、2000单/24小时
- **波动率过滤**: 市场波动过大时自动暂停，降低损耗
- **实时熔断保护**: 检测到短期磨损过高（最近3次循环 > 0.3/万）立即暂停60秒
- **定时交易**: 支持按小时配置交易时间段，可通过 Telegram 动态修改
- **Telegram 控制面板**: 远程查看状态、暂停/继续、切换账号、停止脚本
- **实时盈��追踪**: 通过账户余额变化计算真实盈亏和磨损
- **固定面板显示**: 终端不滚动，实时刷新状态
- **键盘控制**: 按 'q' 键随时平仓退出

## 策略逻辑

1. 通过 WebSocket 实时接收 BTC-USD-PERP 的买一/卖一价格
2. 当价差 ≤ 阈值（默认 0.0005%）且深度充足时触发交易
3. 根据买一/卖一深度决定方向：买一量 ≥ 卖一量则做多，否则做空
4. 一个循环 = 开仓 + 立即平仓（2笔市价单）
5. 完成 800 个循环后自动切换到下一个账号
6. 累计磨损超过阈值（默认 ¥0.3/万）持续 6 秒后自动切换账号
7. 实时磨损超过阈值（最近3次 > 0.3/万）立即暂停 60 秒保护资金
8. **新增**: 所有账号切完一轮后，检查成交量不足的账号并切回继续刷
9. **新增**: 只剩最后一个账号且触发切号条件时，暂停5分钟后继续刷

## 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置账号

编辑 `config.py`，填入账号的 L2 地址和私钥：

```python
ACCOUNTS = [
    {
        "name": "账号1",
        "L2_ADDRESS": "0x你的L2地址",
        "L2_PRIVATE_KEY": "0x你的L2私钥",
    },
    # 可继续添加更多账号...
]
```

**获取方式**: 在 Paradex 网页端导出 Subkey（L2 私钥）

### 3. 配置 Telegram（可选）

```python
TG_ENABLED = True
TG_BOT_TOKEN = "你的BotToken"
TG_CHAT_ID = "你的ChatID"
```

### 4. 运行

```bash
python3 scalper.py
```

**首次运行会提示输入参数：**
- **最小成交量阈值**: 10-500万USD，每个账号必须达到此成交量才算完成
- **最大循环次数**: 100-10000，控制最多轮换多少次

或使用启动脚本：
```bash
bash run.sh
```

运行中按 `q` 键可随时平仓退出。

Windows 可双击 `启动.bat`

## 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `ORDER_SIZE_BTC` | 0.008 | 每单大小 (BTC) |
| `MAX_SPREAD_PERCENT` | 0.0005 | 价差阈值 (%) |
| `MAX_CYCLES` | 800 | 最大循环次数 |
| `SWITCH_COST_PER_10K` | 0.3 | 磨损切换阈值 (元/万) |
| `VOLATILITY_FILTER_ENABLED` | True | 是否启用波动率过滤 |
| `MAX_VOLATILITY_PCT` | 0.08 | 最大允许波动率 (%) |
| `SCHEDULE_ENABLED` | True | 是否启用定时交易 |

**运行时参数（启动时输入）：**
- **最小成交量阈值**: 10-500万USD
- **最大轮次**: 100-10000次

## 速率限制

| 维度 | 限制 |
|------|------|
| 每分钟 | 26 单 |
| 每小时 | 500 单 |
| 每24小时 | 2000 单 |

## 智能账号切换策略

### 切换条件
- 检测到订单被收取手续费（非 Interactive Token）
- 累计磨损超过 `SWITCH_COST_PER_10K` 阈值持续 6 秒
- 完成 `MAX_CYCLES` 次循环后自动切换到下一个账号
- 通过 Telegram 手动切换

### 智能轮换逻辑（新增）

1. **第一轮**: 依次切换4个账号，每个账号刷到触发切号条件为止
2. **检查成交量**: 一轮结束后，检查每个账号的成交量
3. **补刷不足账号**: 成交量未达到最小阈值的账号会被切回去继续刷
4. **优先级排序**: 按成交量从小到大排序，优先刷成交量最少的账号
5. **最后一号保护**:
   - 如果只剩最后一个账号成交量不足且触发切号条件
   - 不会切号，而是暂停5分钟后继续刷当前账号
   - 避免无限循环切号
6. **轮次限制**: 达到最大轮次后停止交易

**示例场景**:
- 设置最小成交量 50万USD
- 第一轮: 账号1刷了30万，账号2刷了60万，账号3刷了20万，账号4刷了55万
- 第二轮: 自动切回账号3（20万，最少），刷够50万后切回账号1（30万）
- 所有账号达标后，开始新一轮

## 熔断保护机制

脚本包含两层磨损保护：

### 1. 实时熔断（快速响应）
- **监控指标**: 最近 3 次循环的磨损率
- **触发条件**: 实时磨损 > 0.3元/万U
- **执行动作**: 立即暂停交易 60 秒
- **适用场景**: 市场突然波动导致短期高磨损

### 2. 累计磨损切号（长期保护）
- **监控指标**: 从账号启动到现在的累计磨损
- **触发条件**: 累计磨损 < -0.3元/万U 且持续 6 秒
- **执行动作**: 切换到下一个账号
- **适用场景**: 账号长期表现不佳

两层保护配合使用，既能快速响应异常，又避免频繁切号。

## 最新修复（v6.1）

### 修复账号切换卡死问题
- **问题**: 切换账号时 WebSocket 关闭后代码继续执行，导致 Broken pipe 错误
- **修复**: 调整代码执行顺序，确保在关闭 WebSocket 前完成所有检查
- **改进**: 切换账号后立即返回触发重连，避免使用已关闭的连接
- **影响**: 解决了脚本在切换账号时卡死的问题，提升稳定性

## Telegram 控制面板

启动后会发送控制面板，支持以下操作：

| 按钮 | 功能 |
|------|------|
| 📊 状态 | 查看详细运行状态 |
| ⏸️ 暂停 | 平仓后暂停交易 |
| ▶️ 继续 | 恢复交易 |
| ⏰ 定时 | 设置交易时间段 |
| 🔄 切号 | 手动切换账号 |
| 🛑 停止 | 平仓后停止脚本 |

## 定时交易

通过 Telegram 定时面板可按小时选择交易时间段，支持预设：
- 🌙 夜间 (0-6点)
- 🌅 早上 (6-12点)
- ☀️ 下午 (12-18点)
- 🌆 晚上 (18-24点)

配置保存在 `schedule_config.json`，重启后自动加载。

## 紧急停止

支持多种方式停止脚本：

1. **按 q 键**: 运行中按 `q` 键，会先平仓再退出
2. **创建 STOP 文件**: 在脚本目录创建名为 `STOP` 的文件
3. **Telegram 控制**: 通过 Telegram 控制面板的 🛑 停止按钮

## 日志

运行日志保存在 `scalper.log`。
